<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Call</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    video {
      width: 45%;
      border: 2px solid #333;
      border-radius: 8px;
      margin: 5px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #inviteBox {
      margin: 15px auto;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fff;
      max-width: 500px;
      display: none;
    }
    #inviteLink {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>WebRTC –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h2>

  <div id="inviteBox">
    <p>–°–∫–æ–ø–∏—Ä—É–π —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É:</p>
    <input id="inviteLink" type="text" readonly>
  </div>

  <div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div>
    <button onclick="createOffer()">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button onclick="endCall()">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let ROOM = urlParams.get('room');

    // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç—ã ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é
    if (!ROOM) {
      ROOM = Math.random().toString(36).slice(2, 8);
      const newUrl = `${window.location.origin}${window.location.pathname}?room=${ROOM}`;
      window.history.replaceState({}, "", newUrl);

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ inviteBox
      const inviteBox = document.getElementById('inviteBox');
      const inviteLink = document.getElementById('inviteLink');
      inviteLink.value = newUrl;
      inviteBox.style.display = "block";
    }

    const isCaller = urlParams.has('call');
    const SIGNAL_URL = 'https://webrtc-signal-78yj.onrender.com'; // —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä
    const CLIENT_ID = Math.random().toString(36).slice(2);

    const config = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:openrelay.metered.ca:80",
          username: "openrelayproject",
          credential: "openrelayproject"
        }
      ]
    };

    const pc = new RTCPeerConnection(config);
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    let iceCandidateBuffer = [];
    let hasRemoteDescription = false;
    let isCallActive = false;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localVideo.srcObject = stream;
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
      })
      .catch(err => alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err));

    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

    async function sendSignalPayload(payload) {
      const msg = Object.assign({}, payload, { room: ROOM, from: CLIENT_ID });
      try {
        await fetch(SIGNAL_URL + '/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(msg)
        });
      } catch (e) {
        console.error('Send failed', e);
      }
    }

    function flushIceCandidates() {
      iceCandidateBuffer.forEach(async candidate => {
        try { await pc.addIceCandidate(candidate); } 
        catch (e) { console.error("ICE candidate error:", e); }
      });
      iceCandidateBuffer = [];
    }

    async function receiveLoop() {
      while (true) {
        try {
          const res = await fetch(`${SIGNAL_URL}/receive?room=${encodeURIComponent(ROOM)}&clientId=${encodeURIComponent(CLIENT_ID)}`);
          if (res.status === 200) {
            const msg = await res.json();

            if (msg.type === 'offer') {
              if (isCallActive) continue;
              isCallActive = true;
              await pc.setRemoteDescription({ type: msg.type, sdp: msg.sdp });
              hasRemoteDescription = true;
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              await sendSignalPayload({ type: answer.type, sdp: answer.sdp });
              flushIceCandidates();
            } else if (msg.type === 'answer') {
              if (isCallActive) continue;
              isCallActive = true;
              await pc.setRemoteDescription({ type: msg.type, sdp: msg.sdp });
              hasRemoteDescription = true;
              flushIceCandidates();
            } else if (msg.type === 'candidate') {
              if (hasRemoteDescription) {
                await pc.addIceCandidate(msg.candidate);
              } else {
                iceCandidateBuffer.push(msg.candidate);
              }
            } else {
              console.log('Unknown message:', msg);
            }
          } else if (res.status === 204) {
            // long polling timeout
          } else {
            console.warn('Receive unexpected status', res.status);
          }
        } catch (e) {
          console.error("Receive error:", e);
          await new Promise(r => setTimeout(r, 1500));
        }
      }
    }

    pc.onicecandidate = e => {
      if (e.candidate) {
        sendSignalPayload({ type: 'candidate', candidate: e.candidate });
      }
    };

    receiveLoop();

    window.createOffer = async () => {
      if (!isCaller) {
        alert("–¢—ã –Ω–µ –º–æ–∂–µ—à—å –∑–≤–æ–Ω–∏—Ç—å. –û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å ?call\n\n–ü—Ä–∏–º–µ—Ä: " + 
              window.location.origin + window.location.pathname + `?room=${ROOM}&call`);
        return;
      }

      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await sendSignalPayload({ type: offer.type, sdp: offer.sdp });
        console.log("‚úÖ Offer sent");
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–∑–æ–≤–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤: " + e.message);
      }
    };

    window.endCall = () => {
      if (localVideo.srcObject) {
        localVideo.srcObject.getTracks().forEach(track => track.stop());
        localVideo.srcObject = null;
      }
      remoteVideo.srcObject = null;
      if (pc) pc.close();
      isCallActive = false;
      console.log("üìû Call ended");
      alert("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω");
    };
  </script>
</body>
</html>
